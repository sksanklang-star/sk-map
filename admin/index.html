<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Soi Hidden)</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/wellknown@1.5.0/wellknown.js"></script>

    <style>
        .bi {
            font-family: "bootstrap-icons" !important;
        }

        /* CSS for Loading Overlay */
        #dataLoadingOverlay {
            position: fixed;
            top: 60px; /* Below navbar */
            left: 0;
            width: 100%;
            height: calc(100vh - 60px);
            background: rgba(255, 255, 255, 0.8); /* Semi-transparent white */
            z-index: 9998; /* High z-index but below login overlay */
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #0d6efd; /* Bootstrap primary color */
            margin-bottom: 15px;
        }

        .loading-text {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }


        #iconInputNew {
            font-family: "Bootstrap Icons";
        }
        body {
            font-family: 'Sarabun', sans-serif;
            overflow: hidden;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-navbar {
            height: 60px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1020;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .modal {
            z-index: 1060 !important;
        }

        .modal-backdrop {
            z-index: 1050 !important;
        }

        .nav-brand {
            font-weight: 700;
            color: #0d6efd;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-tools {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            border: 1px solid #eee;
            background: white;
            padding: 6px 15px;
            border-radius: 20px;
            color: #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #f8f9fa;
        }

        .nav-btn.active {
            background: #e7f1ff;
            color: #0d6efd;
            border-color: #0d6efd;
            font-weight: bold;
        }

        .nav-btn-danger {
            color: #dc3545;
            border-color: #ffeaea;
        }

        .nav-btn-danger:hover {
            background: #dc3545;
            color: white;
        }

        .custom-marker-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        #map {
            flex-grow: 1;
            width: 100%;
            z-index: 1;
        }

        .draggable-panel {
            position: absolute;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1030;
            display: none;
            border: 1px solid #eee;
        }

        .panel-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            border-radius: 10px 10px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-body {
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .leaflet-top {
            top: 10px;
        }

        .list-sidebar {
            position: fixed;
            top: 60px;
            left: -400px;
            width: 350px;
            height: calc(100vh - 60px);
            background: white;
            z-index: 1025;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.15);
            transition: left 0.4s;
            display: flex;
            flex-direction: column;
        }

        .list-sidebar.active {
            left: 0;
        }

        .selection-sidebar {
            position: fixed;
            top: 60px;
            right: -400px;
            width: 350px;
            height: calc(100vh - 60px);
            background: white;
            z-index: 1025;
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.15);
            transition: right 0.4s;
            display: flex;
            flex-direction: column;
        }

        .selection-sidebar.active {
            right: 0;
        }

        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #212529;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .custom-marker-icon {
            display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; color: white; font-size: 16px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid white;
            cursor: pointer !important; pointer-events: auto !important;
            
            /* üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
            font-family: 'bootstrap-icons' !important; 
            font-style: normal;
        }
        .float-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1045;
            display: none;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            align-items: center;
            border: 1px solid #ddd;
            width: 55%;
            align-items: center;
            justify-content: center;
        }

        .snap-tool {
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid #ddd;
            padding-right: 10px;
            margin-right: 5px;
        }

        .snap-label {
            font-size: 0.8rem;
            font-weight: bold;
            width: 35px;
            text-align: right;
        }

        .control-label {
            font-weight: bold;
            font-size: 0.9rem;
            margin-right: 5px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-circle {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 16px;
        }

        .btn-circle:hover {
            transform: scale(1.1);
        }

        .btn-pill {
            padding: 8px 20px;
            border-radius: 30px;
            border: none;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-pill:hover {
            transform: scale(1.05);
        }

        .btn-add {
            background: #ffc107;
            color: #000;
        }

        .btn-eraser {
            background: #6c757d;
            color: white;
        }

        .btn-eraser.active {
            background: #dc3545;
            color: white;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .btn-finish {
            background: #198754;
            color: white;
        }

        .btn-cancel {
            background: #dc3545;
            color: white;
        }

        .layer-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .result-item {
            cursor: pointer;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .result-item:hover {
            background: #f8f9fa;
            border-left: 4px solid #0d6efd;
        }

        .nav-user-badge {
            background: #eee;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            color: #555;
        }

        .modal {
            pointer-events: none;
        }

        .modal-dialog {
            pointer-events: auto;
            z-index: 1070;
        }

        .modal-content {
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            border: none;
            border-radius: 15px;
        }

        .btn-edit-geom {
            width: 100%;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            background-color: #ffc107;
            border: none;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-edit-geom:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .eraser-cursor,
        .eraser-cursor .leaflet-interactive,
        .eraser-cursor path,
        .eraser-cursor .custom-marker-icon {
            /* ‡πÉ‡∏ä‡πâ SVG ‡∏£‡∏π‡∏õ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á Bootstrap ‡∏ú‡πà‡∏≤‡∏ô URL-Encoding */
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='%23dc3545' viewBox='0 0 16 16'%3E%3Cpath d='M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z'/%3E%3Cpath d='M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z'/%3E%3C/svg%3E") 12 12, crosshair !important;
        }
    </style>
</head>

<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h3 class="fw-bold mb-1 text-dark">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
            
            <div id="loginError" class="alert alert-danger d-none p-2 mb-3 mt-3 text-start small" role="alert">
                <i class="fa-solid fa-circle-exclamation"></i> <span id="errorText">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <input type="email" id="authEmail" class="form-control mb-3 mt-3" placeholder="admin@example.com" required>
                
                <div class="input-group mb-4">
                    <input type="password" id="authPassword" class="form-control" placeholder="password" required>
                    <button class="btn btn-outline-secondary" style="min-width: 46px;" type="button" id="btnTogglePassword" onclick="togglePasswordVisibility()">
                        <i class="fa-solid fa-eye"  id="eyeIcon"></i>
                    </button>
                </div>

                <button type="submit" id="loginBtn" class="btn btn-dark w-100 fw-bold py-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
        </div>
    </div>

    <nav class="top-navbar">
        <div class="nav-brand"><i class="fa-solid fa-map-location-dot"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
        <div class="nav-tools">
            <button class="nav-btn" id="btn-filter" onclick="togglePanel('filterPanel', 'btn-filter')"><i
                    class="fa-solid fa-filter"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
            <button class="nav-btn" id="btn-layer" onclick="togglePanel('layerPanel', 'btn-layer')"><i
                    class="fa-solid fa-layer-group"></i> ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå</button>
            <div class="vr mx-2"></div>
            <button class="nav-btn active" id="btn-street" onclick="setMapType('street')">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
            <button class="nav-btn" id="btn-satellite" onclick="setMapType('satellite')">‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</button>
            <div class="vr mx-2"></div>
            <button class="nav-btn nav-btn-danger" onclick="handleLogout()"><i class="fa-solid fa-power-off"></i>
                ‡∏≠‡∏≠‡∏Å</button>
        </div>
    </nav>

    <div id="map"></div>

    <div id="dataLoadingOverlay">
        <div class="spinner-border" role="status"></div>
        <div class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>
    </div>

    <div id="newProjectActions" class="float-controls">
        <span class="control-label">‡πÉ‡∏´‡∏°‡πà (<span id="drawCount">0</span>)</span>

        <div class="vr mx-2"></div>
        <div class="input-group input-group-sm me-2" style="width: 100px;">
            <span class="input-group-text px-1"><i class="bi bi-hash"></i></span>
            <input type="text" id="iconInputNew" class="form-control px-1 text-center" placeholder="&#xF3E7;" oninput="updateRealtimeStyle(this.value, 'new')">
        </div>

        <div class="vr mx-2"></div>
        <input type="color" id="colorInputNew" class="form-control form-control-color me-2" value="#ffc107" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ" oninput="updateRealtimeStyle('new')">
        <div class="vr mx-2"></div>

        <div class="snap-tool">
            <div class="form-check form-switch m-0" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Snap">
                <input class="form-check-input" type="checkbox" id="snapToggleNew" checked
                    onchange="syncSnapSettings('new')">
            </div>
            <input type="range" class="form-range" style="width:70px" id="snapRangeNew" min="5" max="100" value="5"
                oninput="syncSnapSettings('new')" title="‡∏£‡∏∞‡∏¢‡∏∞‡∏î‡∏π‡∏î">
            <span id="snapValNew" class="snap-label text-muted">5px</span>
        </div>

        <button class="btn-circle btn-add" title="‡∏ß‡∏≤‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°" onclick="drawNextPart('new')"><i
                class="fa-solid fa-plus"></i></button>
        <button class="btn-circle btn-eraser" title="‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô" onclick="toggleEraserMode(this)"><i
                class="fa-solid fa-eraser"></i></button>
        <div class="vr mx-2"></div>
        <button class="btn-pill btn-finish" onclick="finishNewProjectDrawing()">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
        <button class="btn-pill btn-cancel" onclick="cancelNewProjectDrawing()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <div id="editGeomControls" class="float-controls">
        <div class="snap-tool">
            <div class="form-check form-switch m-0" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Snap">
                <input class="form-check-input" type="checkbox" id="snapToggleEdit" checked
                    onchange="syncSnapSettings('edit')">
            </div>
            <input type="range" class="form-range" style="width:70px" id="snapRangeEdit" min="5" max="100" value="5"
                oninput="syncSnapSettings('edit')" title="‡∏£‡∏∞‡∏¢‡∏∞‡∏î‡∏π‡∏î">
            <span id="snapValEdit" class="snap-label text-muted">5px</span>
        </div>

        <div class="vr mx-2"></div>
        <div class="input-group input-group-sm me-2" style="width: 100px;">
            <span class="input-group-text px-1"><i class="bi bi-hash"></i></span>
            <input type="text" id="iconInputEdit" class="form-control px-1 text-center" placeholder="&#xF3E7;" oninput="updateRealtimeStyle('edit')">
        </div>
        <div class="vr mx-2"></div>
        <input type="color" id="colorInputEdit" class="form-control form-control-color me-2" value="#ffc107" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ" oninput="updateRealtimeStyle('edit')">
        <div class="vr mx-2"></div>

        <button class="btn-circle btn-add" title="‡∏ß‡∏≤‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°" onclick="drawNextPart('edit')"><i
                class="fa-solid fa-plus"></i></button>
        <button class="btn-circle btn-eraser" title="‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô" onclick="toggleEraserMode(this)"><i
                class="fa-solid fa-eraser"></i></button>
        <div class="vr mx-2"></div>
        <button class="btn-pill btn-finish" onclick="finishGeometryEdit()">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
        <button class="btn-pill btn-cancel" onclick="cancelGeometryEdit()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <div id="filterPanel" class="draggable-panel" style="top: 80px; left: 60px;">
        <div class="panel-header">
            <h6 class="panel-title"><i class="fa-solid fa-magnifying-glass"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á</h6><i
                class="fa-solid fa-xmark panel-close" onclick="togglePanel('filterPanel', 'btn-filter')"></i>
        </div>
        <div class="panel-body">
            <div class="mb-2"><select id="filterYear" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì --</option>
                </select></div>
            <div class="mb-3"><select id="filterMoo" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô --</option>
                    <option value="1">‡∏´‡∏°‡∏π‡πà 1</option>
                    <option value="2">‡∏´‡∏°‡∏π‡πà 2</option>
                    <option value="3">‡∏´‡∏°‡∏π‡πà 3</option>
                    <option value="4">‡∏´‡∏°‡∏π‡πà 4</option>
                    <option value="5">‡∏´‡∏°‡∏π‡πà 5</option>
                </select></div>
            <button onclick="toggleListSidebar()" class="btn btn-primary w-100 rounded-pill fw-bold btn-sm"><i
                    class="fa-solid fa-list-ul"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ / ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
    </div>

    <div id="layerPanel" class="draggable-panel" style="top: 80px; left: 380px;">
        <div class="panel-header">
            <h6 class="panel-title"><i class="fa-solid fa-layers"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå</h6><i
                class="fa-solid fa-xmark panel-close" onclick="togglePanel('layerPanel', 'btn-layer')"></i>
        </div>
        <div class="panel-body">
            <div class="layer-item" onclick="toggleLayer('project', this)"><span class="small fw-bold"><i
                        class="fa-solid fa-circle text-warning me-2"></i> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span><i
                    class="fa-solid fa-eye text-primary"></i></div>

            <div class="layer-item" onclick="toggleLayer('soi', this)">
                <span class="small fw-bold"><i class="fa-solid fa-road text-secondary me-2"></i> ‡∏ã‡∏≠‡∏¢ (Soi)</span>
                <i class="fa-solid fa-eye-slash text-muted eye-icon"></i>
            </div>

            <div class="layer-item" onclick="toggleLayer('moo', this)"><span class="small fw-bold"><i
                        class="fa-regular fa-square text-primary me-2"></i> ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏´‡∏°‡∏π‡πà</span><i
                    class="fa-solid fa-eye text-primary"></i></div>
            <div class="layer-item" onclick="toggleLayer('boundary', this)"><span class="small fw-bold"><i
                        class="fa-regular fa-square text-danger me-2"></i> ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≥‡∏ö‡∏•</span><i
                    class="fa-solid fa-eye text-primary"></i></div>
        </div>
    </div>

    <div id="listSidebar" class="list-sidebar">
        <div class="sidebar-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fa-solid fa-list me-2"></i>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h5><button
                    class="btn btn-sm btn-outline-light rounded-circle" onclick="toggleListSidebar()"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <div class="p-3 bg-light border-bottom"><input type="text" id="sidebarSearch" class="form-control rounded-pill"
                placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£..." onkeyup="applyFilters()">
            <div class="text-end mt-1"><small class="text-muted" id="resultCount">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small></div>
        </div>
        <div id="sidebarList" class="list-group list-group-flush" style="overflow-y:auto; flex-grow:1;"></div>
    </div>

    <div id="selectionSidebar" class="selection-sidebar">
        <div class="sidebar-header d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
            <h5 class="mb-0 fw-bold text-primary"><i class="fa-solid fa-circle-info me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
            <button class="btn btn-md btn-outline-secondary rounded-circle" onclick="closeSidebar()"><i
                    class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="sidebarContent" class="p-3" style="overflow-y:auto; flex-grow:1;"></div>
    </div>

    <div class="modal fade" id="projectFormModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="cancelModal()"></button>
                </div>
                <div class="modal-body">
                    <button type="button" class="btn btn-edit-geom" id="btnStartEditGeom" onclick="startGeometryEdit()">
                        <i class="fa-solid fa-pen-to-square"></i> ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á / ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô
                    </button>

                    <form id="newProjectForm">
                        <input type="hidden" id="editProjectId">
                        <div class="mb-3"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                            <textarea class="form-control" id="inpName" rows="3" required></textarea>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label>‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</label><select id="inpMoo" class="form-select">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                </select></div>
                            <div class="col-6"><label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label><input type="text" id="inpDept"
                                    class="form-control" value="‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á" required></div>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-muted small fw-bold mb-0">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h6><button type="button"
                                class="btn btn-sm btn-outline-success" onclick="addBudgetRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ</button>
                        </div>
                        <div id="budgetList"></div>
                    </form>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" id="btnDelete" class="btn btn-danger" style="display:none;"
                        onclick="deleteProject()"><i class="fa-solid fa-trash"></i> ‡∏•‡∏ö</button>
                    <div><button type="button" class="btn btn-secondary" onclick="cancelModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button
                            type="button" class="btn btn-primary fw-bold" onclick="saveProject()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const supabaseUrl = 'https://azxinrvdwsvmchovvjpl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6eGlucnZkd3N2bWNob3Z2anBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MTY4NzMsImV4cCI6MjA4NjE5Mjg3M30.52JBZ4CFEKyVZMmTgNFgEUek75EyAbP0D7kxELh2EZk';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        var map = L.map('map', { center: [18.784, 99.075], zoom: 14, zoomControl: false, maxZoom: 22 });
        var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            attribution: '¬© OpenStreetMap',
            maxNativeZoom: 19, // ‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏µ‡∏ñ‡∏∂‡∏á‡πÅ‡∏Ñ‡πà‡∏ô‡∏µ‡πâ
            maxZoom: 22        // ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ã‡∏π‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ (‡∏†‡∏≤‡∏û‡∏à‡∏∞‡πÅ‡∏ï‡∏Å‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Ç‡∏∂‡πâ‡∏ô)
        }).addTo(map);        
        
        var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
            attribution: 'Tiles ¬© Esri',
            maxNativeZoom: 19, 
            maxZoom: 22 
        });        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // üî• ‡∏™‡∏£‡πâ‡∏≤‡∏á Pane ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡∏ã‡∏≠‡∏¢ (Z-Index ‡∏™‡∏π‡∏á‡πÜ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ó‡∏±‡∏ö)
        map.createPane('soiPane');
        map.getPane('soiPane').style.zIndex = 450;

        let currentDrawnLayer = null;
        let tempNewLayersGroup = L.featureGroup().addTo(map);
        let tempExtraPartsGroup = L.featureGroup().addTo(map);
        let projectLayerGroup = L.featureGroup().addTo(map);
        let currentEditLayer = null;
        let isManualMode = false;

        let originalGeoJSONBackup = null;
        let originalStyleBackup = null;
        let currentStack = [];
        let isEraserActive = false;

        let mooLayer, boundaryLayer, soiLayer;
        let allFeatures = [];
        let filteredFeaturesGlobal = [];

        function togglePanel(id, btnId) { const p = document.getElementById(id); const b = document.getElementById(btnId); p.style.display = (p.style.display === 'none' || p.style.display === '') ? 'block' : 'none'; if (b) b.classList.toggle('active'); }
        function preventMapClick(id) { const el = document.getElementById(id); if (el) { L.DomEvent.disableClickPropagation(el); L.DomEvent.disableScrollPropagation(el); } }
        preventMapClick('editGeomControls'); preventMapClick('newProjectActions'); preventMapClick('filterPanel'); preventMapClick('layerPanel'); preventMapClick('listSidebar'); preventMapClick('selectionSidebar');

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; element.querySelector('.panel-header').onmousedown = e => { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDrag; document.onmousemove = elmDrag; };
            function elmDrag(e) { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; element.style.top = (element.offsetTop - pos2) + "px"; element.style.left = (element.offsetLeft - pos1) + "px"; }
            function closeDrag() { document.onmouseup = null; document.onmousemove = null; }
        }
        makeDraggable(document.getElementById("filterPanel")); makeDraggable(document.getElementById("layerPanel"));

        // this is function that loading data and show reload while fetching data
        async function checkSession() { 
            const { data: { session } } = await db.auth.getSession(); 
            
            if (session) { 
                // 1. Hide Login Overlay
                document.getElementById('loginOverlay').style.opacity = '0'; 
                
                setTimeout(async () => { 
                    document.getElementById('loginOverlay').style.visibility = 'hidden'; 
                    initAdminTools(); 
                    
                    // 2. SHOW Loading Overlay
                    document.getElementById('dataLoadingOverlay').style.display = 'flex';

                    try {
                        // 3. Run all data fetching AT THE SAME TIME using Promise.all
                        // This makes loading much faster than waiting for one to finish before starting the next.
                        await Promise.all([
                            loadExistingProjects(),
                            loadMoo(),
                            loadBoundary(),
                            loadSoi()
                        ]);
                    } catch (error) {
                        console.error("Error loading map data:", error);
                        // Optional: Show an error message to the user here
                    } finally {
                        // 4. HIDE Loading Overlay when everything is done (or if an error occurs)
                        document.getElementById('dataLoadingOverlay').style.display = 'none';
                    }

                }, 500); 
            } 
        }
        

        async function handleLogin(e) { 
            e.preventDefault(); 
            
            const btn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');

            // 1. ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á Error ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
            errorDiv.classList.add('d-none');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<span> verifying . . .  </span>';
            btn.disabled = true;

            // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö Supabase
            const { error } = await db.auth.signInWithPassword({ 
                email: document.getElementById('authEmail').value, 
                password: document.getElementById('authPassword').value 
            }); 
            
            // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            if (error) { 
                // ‡∏ñ‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î: ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏î‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
                if (error.message.includes('Invalid login credentials')) {
                    errorText.innerText = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                } else {
                    errorText.innerText = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                }
                errorDiv.classList.remove('d-none');
                
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            } else { 
                // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å: ‡πÑ‡∏õ‡∏ï‡πà‡∏≠ (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkSession ‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô Overlay ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á)
                checkSession(); 
            } 
        }
        async function handleLogout() { await db.auth.signOut(); window.location.reload(); }
        function setMapType(type) { if (type === 'street') { map.addLayer(streetMap); map.removeLayer(satelliteMap); } else { map.addLayer(satelliteMap); map.removeLayer(streetMap); } document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-' + type).classList.add('active'); }

        function initAdminTools() {
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á New ‡∏°‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Default Cursor
            const initialIcon = document.getElementById('iconInputNew').value;
            const initialColor = document.getElementById('colorInputNew').value;
            const startIcon = getCustomIcon(initialIcon, initialColor);

            map.pm.setGlobalOptions({ 
                snappable: true, 
                snapDistance: 30, 
                allowSelfIntersection: true, 
                pinning: true,
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Cursor ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                markerStyle: { icon: startIcon },      
                hintMarkerStyle: { icon: startIcon },
                templineStyle: { color: initialColor },
                hintlineStyle: { color: initialColor, dashArray: [5, 5] }
            });

            map.pm.addControls({
                position: 'topleft',
                drawMarker: true, drawPolygon: true, drawPolyline: true,
                drawRectangle: false, drawCircle: false, drawCircleMarker: false, drawText: false,
                editMode: false, dragMode: false, cutPolygon: false, removalMode: false, rotateMode: false
            });

            map.on('pm:drawstart', () => { isManualMode = true; });
            map.on('pm:drawend', () => { setTimeout(() => { isManualMode = false; }, 200); });

            map.on('pm:globaldrawmodetoggled', (e) => {
            if (e.enabled) {
                resetEraserTool();
            }
        });

            map.on('pm:create', (e) => {
                const layer = e.layer;
                map.removeLayer(layer);

                const snapOpts = getCurrentSnapSettings();
                setupFocusClick(layer);

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏≤‡∏î‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏´‡∏ô (New ‡∏´‡∏£‡∏∑‡∏≠ Edit)
                const isEditMode = document.getElementById('editGeomControls').style.display === 'flex';
                const context = isEditMode ? 'Edit' : 'New';

                // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á Input ‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
                const iconCode = document.getElementById('iconInput' + context).value;
                const colorCode = document.getElementById('colorInput' + context).value;

                // ‡πÉ‡∏™‡πà Style ‡πÉ‡∏´‡πâ Layer ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
                if (layer instanceof L.Marker) {
                    layer.setIcon(getCustomIcon(iconCode, colorCode));
                } else {
                    layer.setStyle({ color: colorCode, weight: 4, dashArray: isEditMode ? "5, 5" : null });
                }

                // ‡∏ù‡∏±‡∏á‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏¢‡∏≤‡∏á‡∏•‡∏ö
                setupEditableLayer(layer);

                // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ Group ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                if (isEditMode) {
                    tempExtraPartsGroup.addLayer(layer);
                    layer.addTo(map);
                } else {
                    tempNewLayersGroup.addLayer(layer);
                    layer.addTo(map);
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ Snap ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
                    layer.pm.enable({ 
                        allowSelfIntersection: true, 
                        draggable: false, 
                        pinning: true, 
                        snappable: true, 
                        snapDistance: 30 
                    });
                    updateNewProjectButtons();
                }
            });

            tempNewLayersGroup.on('layerremove', updateNewProjectButtons);
        }

        
        // ==========================================
        // üî• STACK SEARCH LOGIC
        // ==========================================
        function isPointInPolygon(point, vs) {
            var x = point[0], y = point[1]; var inside = false;
            for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                var xi = vs[i][0], yi = vs[i][1]; var xj = vs[j][0], yj = vs[j][1];
                var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            } return inside;
        }
        function isPointInMultiPolygon(point, multiPolyCoords) {
            for (let i = 0; i < multiPolyCoords.length; i++) {
                let ring = multiPolyCoords[i][0]; if (isPointInPolygon(point, ring)) return true;
            } return false;
        }

        function handleStackClick(e) {
            if (isManualMode) return;

            const clickLat = e.latlng.lat;
            const clickLng = e.latlng.lng;
            const clickPoint = [clickLng, clickLat]; // GeoJSON uses [Lng, Lat]
            const clickPx = map.latLngToContainerPoint(e.latlng); // For pixel calculation (optional)

            const foundProjects = [];

            filteredFeaturesGlobal.forEach(feature => {
                const geom = feature.geometry;

                // 1. Polygon
                if (geom.type === 'Polygon') {
                    if (isPointInPolygon(clickPoint, geom.coordinates[0])) foundProjects.push(feature);
                }
                // 2. MultiPolygon
                else if (geom.type === 'MultiPolygon') {
                    if (isPointInMultiPolygon(clickPoint, geom.coordinates)) foundProjects.push(feature);
                }
                // 3. Point
                else if (geom.type === 'Point') {
                    const pLat = geom.coordinates[1];
                    const pLng = geom.coordinates[0];
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á 20 ‡πÄ‡∏°‡∏ï‡∏£ (‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ô)
                    const dist = map.distance(e.latlng, L.latLng(pLat, pLng));
                    if (dist < 20) foundProjects.push(feature);
                }
                // 4. üî• NEW: MultiPoint Logic
                else if (geom.type === 'MultiPoint') {
                    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î‡πÉ‡∏ô MultiPoint
                    for (let coord of geom.coordinates) {
                        const pLng = coord[0];
                        const pLat = coord[1];
                        const dist = map.distance(e.latlng, L.latLng(pLat, pLng));

                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏ß‡πà‡∏≤ 20 ‡πÄ‡∏°‡∏ï‡∏£ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß (Break)
                        if (dist < 20) {
                            foundProjects.push(feature);
                            break;
                        }
                    }
                }
                // 5. LineString & MultiLineString
                else if (geom.type.includes('Line')) {
                    const pt = turf.point([clickLng, clickLat]);
                    let isNear = false;
                    try {
                        if (geom.type === 'MultiLineString') {
                            for (let coords of geom.coordinates) {
                                const line = turf.lineString(coords);
                                const d = turf.pointToLineDistance(pt, line, { units: 'meters' });
                                if (d < 15) { isNear = true; break; }
                            }
                        } else {
                            const ln = turf.lineString(geom.coordinates);
                            const d = turf.pointToLineDistance(pt, ln, { units: 'meters' });
                            if (d < 15) isNear = true;
                        }
                    } catch (err) { console.log('Line check error', err); }

                    if (isNear) foundProjects.push(feature);
                }
            });

            if (foundProjects.length > 0) {
                L.DomEvent.stopPropagation(e);
                openSidebar(foundProjects);
            }
        }

        map.on('click', handleStackClick);

        function openSidebar(features) {
            currentStack = features;
            if (features.length > 1) { showStackList(features); }
            else if (features.length === 1) { renderDetail(features[0].properties); }
        }

        function showStackList(features) {
            const content = document.getElementById('sidebarContent');
            let listHtml = `<h5 class="fw-bold mb-3 text-dark"><i class="fa-solid fa-layer-group text-primary"></i> ‡∏û‡∏ö ${features.length} ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h5><div class="list-group">`;
            features.forEach((f, index) => {
                const p = f.properties;
                listHtml += `<button onclick="openDetailFromStack(${index})" class="list-group-item list-group-item-action p-3 mb-2 border rounded shadow-sm text-start"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 fw-bold text-primary text-truncate" style="max-width: 200px;">${p.name || p.project}</h6></div><small class="text-muted"><i class="fa-solid fa-building"></i> ${p.dept || p.authority}</small></button>`;
            });
            listHtml += `</div>`;
            content.innerHTML = listHtml;
            document.getElementById('selectionSidebar').classList.add('active');
        }

        function openDetailFromStack(index) { renderDetail(currentStack[index].properties); }

        function renderDetail(props) {
            const content = document.getElementById('sidebarContent');
            let budgetHtml = '';
            if (props.budget_history && props.budget_history.length > 0) {
                props.budget_history.forEach(b => { const money = new Intl.NumberFormat('th-TH').format(b.amount); budgetHtml += `<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-white"><span class="badge bg-primary">‡∏õ‡∏µ ${b.year}</span><span class="fw-bold text-dark">${money} ‡∏ö‡∏≤‡∏ó</span></div>`; });
            } else { budgetHtml = `<div class="text-center text-muted p-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>`; }

            let backBtn = '';
            if (currentStack.length > 1) { backBtn = `<button onclick="showStackList(currentStack)" class="btn btn-sm btn-outline-secondary mb-3"><i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>`; }

            content.innerHTML = `
                ${backBtn}
                <h4 class="fw-bold text-primary mb-3" style="line-height:1.4;">${props.name || props.project}</h4>
                <div class="bg-white p-3 rounded shadow-sm border mb-3">
                    <div class="mb-2"><strong><i class="fa-solid fa-map-pin text-danger me-2"></i>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong> ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà ${props.moo}</div>
                    <div class="mb-0"><strong><i class="fa-solid fa-building text-info me-2"></i>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${props.dept || props.authority}</div>
                </div>
                
                <h6 class="fw-bold mt-2 mb-2 text-secondary">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h6>
                <div class="bg-light p-2 rounded border mb-4">${budgetHtml}</div>

                <div class="d-grid">
                    <button class="btn btn-warning fw-bold text-dark py-2" onclick="triggerEditFromSidebar('${props.fid || props.id}')">
                        <i class="fa-solid fa-pen-to-square me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
                    </button>
                </div>
            `;
            document.getElementById('selectionSidebar').classList.add('active');
        }

        function triggerEditFromSidebar(fid) {
            const layer = projectLayerGroup.getLayers().find(l => (l.feature.properties.fid == fid || l.feature.properties.id == fid));
            if (layer) {
                closeSidebar();
                openEditModal(layer.feature, layer);
            }
        }

        function closeSidebar() { document.getElementById('selectionSidebar').classList.remove('active'); }

        // ==========================================
        // STANDARD FUNCTIONS
        // ==========================================
        function getCurrentSnapSettings() {
            const context = document.getElementById('editGeomControls').style.display === 'flex' ? 'edit' : 'new';
            const isSnap = document.getElementById(context === 'edit' ? 'snapToggleEdit' : 'snapToggleNew').checked;
            const dist = parseInt(document.getElementById(context === 'edit' ? 'snapRangeEdit' : 'snapRangeNew').value);
            return { snappable: isSnap, snapDistance: dist };
        }

        function syncSnapSettings(context) {
            const isSnap = document.getElementById(context === 'edit' ? 'snapToggleEdit' : 'snapToggleNew').checked;
            const dist = parseInt(document.getElementById(context === 'edit' ? 'snapRangeEdit' : 'snapRangeNew').value);
            document.getElementById(context === 'edit' ? 'snapValEdit' : 'snapValNew').innerText = dist + 'px';
            map.pm.setGlobalOptions({ snappable: isSnap, snapDistance: dist });

            const refreshLayer = (l) => {
                if (l.pm.enabled()) {
                    l.pm.disable();
                    l.pm.enable({ allowSelfIntersection: true, draggable: false, pinning: true, snappable: isSnap, snapDistance: dist });
                }
            };
            tempNewLayersGroup.eachLayer(refreshLayer);
            tempExtraPartsGroup.eachLayer(refreshLayer);
            if (currentEditLayer) refreshLayer(currentEditLayer);
        }

        function setupFocusClick(layer) {
            layer.on('click', (e) => {
                if (!isManualMode) return;
                L.DomEvent.stopPropagation(e);
                const snapOpts = getCurrentSnapSettings();
                if (currentEditLayer) currentEditLayer.pm.disable();
                tempExtraPartsGroup.eachLayer(l => l.pm.disable());
                tempNewLayersGroup.eachLayer(l => l.pm.disable());
                layer.pm.enable({ allowSelfIntersection: true, draggable: false, pinning: true, ...snapOpts });
            });
        }

        function getRandomColor() {
            const colors = ['#e040fb', '#00e676', '#ffea00', '#ff3d00', '#2979ff', '#f50057','#005F02','#C0B87A','#F075AE','#26CCC2','#001BB7','#7B542F','#2D4F2B'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function startGeometryEdit() {
            if (!currentEditLayer) return;
            
            // 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≤‡∏á‡∏•‡∏ö
            resetEraserTool();

            isManualMode = true;
            bootstrap.Modal.getInstance(document.getElementById('projectFormModal')).hide();

            // Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
            originalGeoJSONBackup = currentEditLayer.toGeoJSON();
            originalStyleBackup = { ...currentEditLayer.options };

            const geoJson = currentEditLayer.toGeoJSON();
            const props = geoJson.properties || {};

            // ‡∏•‡∏ö Layer ‡∏£‡∏ß‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡πÜ)
            projectLayerGroup.removeLayer(currentEditLayer);

            // ‡πÅ‡∏ï‡∏Å Multi-Geometry ‡πÄ‡∏õ‡πá‡∏ô Feature ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÜ
            let features = [];
            if (geoJson.geometry.type === 'LineString' || geoJson.geometry.type === 'Polygon' || geoJson.geometry.type === 'Point') {
                features.push(geoJson);
            } else if (geoJson.geometry.type.includes('Multi')) {
                const type = geoJson.geometry.type.replace('Multi', '');
                geoJson.geometry.coordinates.forEach(coords => {
                    features.push({ type: 'Feature', properties: geoJson.properties, geometry: { type: type, coordinates: coords } });
                });
            }

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á Layer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            features.forEach(feature => {
                let tempLayer;
                
                // ‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏à‡∏≤‡∏Å Database (‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Point)
                const dbIcon = feature.properties.icon || '&#xF3E7;';
                const dbColor = feature.properties.color || '#ffc107';

                if (feature.geometry.type === 'Point') {
                    // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô "‡∏à‡∏∏‡∏î": ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å Database (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≠)
                    tempLayer = L.marker([feature.geometry.coordinates[1], feature.geometry.coordinates[0]], { 
                        icon: getCustomIcon(dbIcon, dbColor), 
                        draggable: true 
                    });
                } else {
                    // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡πâ‡∏ô/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà": ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏™‡∏µ (Random) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏á‡πà‡∏≤‡∏¢
                    // (‡πÉ‡∏ä‡πâ getRandomColor() ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢)
                    const randomColor = getRandomColor();
                    
                    tempLayer = L.geoJSON(feature, { 
                        style: { color: randomColor, weight: 4, dashArray: "10, 5" } 
                    }).getLayers()[0];
                    tempLayer.pm.enable({ draggable: true, snappable: true });
                }
                
                setupEditableLayer(tempLayer);
                tempExtraPartsGroup.addLayer(tempLayer);
                tempLayer.addTo(map);
            });

            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ "‡∏™‡∏µ‡∏à‡∏£‡∏¥‡∏á" ‡πÉ‡∏™‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î Save ‡∏™‡∏µ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° DB)
            document.getElementById('iconInputEdit').value = props.icon || '&#xF3E7;';
            document.getElementById('colorInputEdit').value = props.color || '#ffc107';

            document.getElementById('editGeomControls').style.display = 'flex';
        }

        function drawNextPart(context) {
            tempExtraPartsGroup.eachLayer(l => l.pm.disable());
            tempNewLayersGroup.eachLayer(l => l.pm.disable());
            const snapOpts = getCurrentSnapSettings();

            let type = 'Line';
            let targetGroup = null;

            if (tempExtraPartsGroup.getLayers().length > 0) targetGroup = tempExtraPartsGroup;
            else if (tempNewLayersGroup.getLayers().length > 0) targetGroup = tempNewLayersGroup;

            if (targetGroup) {
                const l = targetGroup.getLayers()[0];
                if (l instanceof L.Marker) type = 'Marker';
                else if (l instanceof L.Polygon) type = 'Polygon';
                else if (l instanceof L.Polyline) type = 'Line';
            }

            // 1. üî• FIX: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î
            const isEditMode = document.getElementById('editGeomControls').style.display === 'flex';
            
            const iconCode = isEditMode 
                ? document.getElementById('iconInputEdit').value 
                : document.getElementById('iconInputNew').value;
            
            const colorCode = isEditMode 
                ? document.getElementById('colorInputEdit').value 
                : document.getElementById('colorInputNew').value;

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            const options = {
                pinning: true,
                snappable: snapOpts.snappable,
                snapDistance: snapOpts.snapDistance
            };

            if (type === 'Marker') {
                // üî• FIX: ‡∏™‡πà‡∏á colorCode ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô getCustomIcon ‡∏î‡πâ‡∏ß‡∏¢ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!)
                const customIcon = getCustomIcon(iconCode, colorCode);

                options.markerStyle = { icon: customIcon };      
                options.hintMarkerStyle = { icon: customIcon };  
            } else {
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡πÄ‡∏™‡πâ‡∏ô/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
                options.finishOn = 'dblclick';
                options.allowSelfIntersection = true;
                
                // üî• FIX: ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß hardcode)
                options.templineStyle = { color: colorCode, dashArray: "5, 5" };
                options.hintlineStyle = { color: colorCode, dashArray: "5, 5" };
            }

            map.pm.enableDraw(type, options);
        }

        function cancelGeometryEdit() {
            tempExtraPartsGroup.clearLayers();
            map.pm.disableDraw();
            map.pm.disableGlobalRemovalMode();
            document.getElementById('editGeomControls').style.display = 'none';

            resetEraserTool();

            if (originalGeoJSONBackup) {
                // ... (Logic ‡∏•‡∏ö Layer ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                if (currentEditLayer && projectLayerGroup.hasLayer(currentEditLayer)) {
                    projectLayerGroup.removeLayer(currentEditLayer);
                }

                // ... (Logic ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô Layer ‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                const restoredLayer = L.geoJSON(originalGeoJSONBackup, {
                    style: (f) => ({ color: f.properties.color || '#ffc107', weight: f.geometry.type.includes('Line') ? 6 : 2, opacity: 0.9 }),
                    interactive: true,
                    pointToLayer: (f, latlng) => {
                        const iconCode = f.properties.icon || 'default';
                        const colorCode = f.properties.color || '#ffc107';
                        const marker = L.marker(latlng, { icon: getCustomIcon(iconCode, colorCode) });
                        marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleStackClick(e); });
                        return marker;
                    },
                    onEachFeature: (f, l) => { l.on('click', (e) => { handleStackClick(e); }); }
                }).getLayers()[0];
                
                currentEditLayer = restoredLayer;
                projectLayerGroup.addLayer(currentEditLayer);

                // üî• FIX: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Input (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/‡∏™‡∏µ) ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (Backup) ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                // (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ User ‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
                const oldProps = originalGeoJSONBackup.properties || {};
                document.getElementById('iconInputEdit').value = oldProps.icon || '&#xF3E7;';
                document.getElementById('colorInputEdit').value = oldProps.color || '#ffc107';
            }
            
            isManualMode = false;
            new bootstrap.Modal(document.getElementById('projectFormModal')).show();
        }

        // 1. Generate Icon from Unicode
        function getCustomIcon(code, color) {
            // Default Values
            if (!code || code === 'default') code = '&#xF3E7;';
            if (!color) color = '#ffc107';

            return L.divIcon({
                className: 'custom-div-icon',
                // ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á Unicode ‡πÅ‡∏•‡∏∞ Color ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
                html: `<div class="custom-marker-icon" style="width:30px;height:30px; background:${color};">${code}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }
        // 2. üî• Real-time Preview Function (Called by Input oninput)
        // 1. ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Color ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
        function getCustomIcon(code, color) {
            if (!code || code === 'default') code = '&#xF3E7;';
            if (!color) color = '#ffc107'; // Default Yellow

            return L.divIcon({
                className: 'custom-div-icon',
                // üî• FIX: ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ color ‡πÉ‡∏ô style background
                html: `<div class="custom-marker-icon" style="width:30px;height:30px; background:${color};">${code}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }

        // 2. üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô updateRealtimeStyle (‡∏£‡∏ß‡∏°‡∏™‡∏µ+‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô)
        function updateRealtimeStyle(context) {
            // 1. Get Values
            const iconId = context === 'edit' ? 'iconInputEdit' : 'iconInputNew';
            const colorId = context === 'edit' ? 'colorInputEdit' : 'colorInputNew';
            
            // Safety check if elements exist
            const iconEl = document.getElementById(iconId);
            const colorEl = document.getElementById(colorId);
            if (!iconEl || !colorEl) return;

            const iconVal = iconEl.value;
            const colorVal = colorEl.value;

            // 2. Identify which group to update
            const group = (context === 'edit') ? tempExtraPartsGroup : tempNewLayersGroup;
            
            // 3. üî• FIX: Loop through EXISTING layers and update them
            group.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    // Update Marker Icon
                    layer.setIcon(getCustomIcon(iconVal, colorVal));
                } else {
                    // Update Line/Polygon Color
                    layer.setStyle({ color: colorVal });
                }
            });

            // 4. Update the Cursor (for the NEXT click)
            const newIcon = getCustomIcon(iconVal, colorVal);
            map.pm.setGlobalOptions({
                markerStyle: { icon: newIcon },
                hintMarkerStyle: { icon: newIcon },
                templineStyle: { color: colorVal },
                hintlineStyle: { color: colorVal, dashArray: [5, 5] }
            });
        }

        function finishGeometryEdit() {
            const layers = tempExtraPartsGroup.getLayers();
            const activeLayers = layers.filter(l => map.hasLayer(l));

            if (activeLayers.length > 0) {
                // ... (Logic ‡∏£‡∏ß‡∏° Geometry ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                const firstGeo = activeLayers[0].toGeoJSON();
                const type = firstGeo.geometry.type;
                let newType;
                let allCoords = [];

                if (type === 'Point') { newType = 'MultiPoint'; activeLayers.forEach(l => allCoords.push(l.toGeoJSON().geometry.coordinates)); }
                else if (type === 'LineString') { newType = 'MultiLineString'; activeLayers.forEach(l => allCoords.push(l.toGeoJSON().geometry.coordinates)); }
                else { newType = 'MultiPolygon'; activeLayers.forEach(l => allCoords.push(l.toGeoJSON().geometry.coordinates)); }

                const newGeoJSON = { type: 'Feature', geometry: { type: newType, coordinates: allCoords }, properties: currentEditLayer.feature.properties };
                const currentIcon = document.getElementById('iconInputEdit').value;
                const currentColor = document.getElementById('colorInputEdit').value;

                const newLayer = L.geoJSON(newGeoJSON, {
                    style: { color: currentColor, weight: (newType.includes('Line') ? 6 : 2), opacity: 0.9 },
                    interactive: true,
                    pointToLayer: (f, latlng) => {
                        const marker = L.marker(latlng, { icon: getCustomIcon(currentIcon, currentColor) });
                        marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleStackClick(e); });
                        return marker;
                    },
                    onEachFeature: (f, l) => { if (f.geometry.type !== 'Point') l.on('click', (e) => { L.DomEvent.stopPropagation(e); handleStackClick(e); }); }
                });

                currentEditLayer = newLayer.getLayers()[0];
                projectLayerGroup.addLayer(currentEditLayer);
            } else {
                cancelGeometryEdit();
                return; 
            }

            tempExtraPartsGroup.clearLayers();
            if (map.pm.globalRemovalModeEnabled()) map.pm.disableGlobalRemovalMode();

            // üî• FIX: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≤‡∏á‡∏•‡∏ö
            resetEraserTool();
            isManualMode = false;

            document.getElementById('editGeomControls').style.display = 'none';
            new bootstrap.Modal(document.getElementById('projectFormModal')).show();

            document.getElementById("iconInputNew").value = "&#xF3E7;";
            initAdminTools();
        }


        function setupEditableLayer(layer) {
            // ‡∏•‡∏ö event click ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥)
            layer.off('click');
            
            // ‡πÉ‡∏™‡πà event click ‡πÉ‡∏´‡∏°‡πà
            layer.on('click', (e) => {
                // 1. ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∑‡∏≠‡∏¢‡∏≤‡∏á‡∏•‡∏ö‡∏≠‡∏¢‡∏π‡πà
                if (isEraserActive) {
                    L.DomEvent.stopPropagation(e); // ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡πÇ‡∏î‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    
                    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏´‡∏°? (Extra ‡∏´‡∏£‡∏∑‡∏≠ New)
                    if (tempExtraPartsGroup.hasLayer(layer)) {
                        tempExtraPartsGroup.removeLayer(layer);
                        map.removeLayer(layer);
                    } 
                    else if (tempNewLayersGroup.hasLayer(layer)) {
                        tempNewLayersGroup.removeLayer(layer);
                        map.removeLayer(layer);
                        updateNewProjectButtons(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                    }
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô 2 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô projectLayerGroup ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô) -> ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢!)
                } 
                // 3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏∑‡∏≠‡∏¢‡∏≤‡∏á‡∏•‡∏ö -> ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô Focus ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠)
                else {
                     // ‡πÉ‡∏™‡πà Logic ‡∏Å‡∏≤‡∏£ Focus ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                     // ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Edit ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©
                }
            });
        }

        function resetEraserTool() {
            // 1. Reset logic state
            isEraserActive = false;
            
            // 2. Remove UI Active Class from all eraser buttons
            document.querySelectorAll('.btn-eraser').forEach(btn => {
                btn.classList.remove('active');
            });

            // 3. Remove Map Cursor CSS
            map.getContainer().classList.remove('eraser-cursor');

            // 4. Disable Geoman Global Removal (Just in case)
            if (map.pm.globalRemovalModeEnabled()) {
                map.pm.disableGlobalRemovalMode();
            }
        }

        function toggleEraserMode(btn) {
            map.pm.disableDraw();
            // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            isEraserActive = !isEraserActive;
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏¢‡∏≤‡∏á‡∏•‡∏ö
            if (isEraserActive) {
                btn.classList.add('active');
                map.getContainer().classList.add('eraser-cursor'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ css)
                
                // ‚õî ‡∏õ‡∏¥‡∏î Global Removal ‡∏Ç‡∏≠‡∏á Geoman ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î
                if (map.pm.globalRemovalModeEnabled()) {
                    map.pm.disableGlobalRemovalMode();
                }
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏¢‡∏≤‡∏á‡∏•‡∏ö
                btn.classList.remove('active');
                map.getContainer().classList.remove('eraser-cursor');
            }
        }

        function updateNewProjectButtons() {
            const count = tempNewLayersGroup.getLayers().length;
            const container = document.getElementById('newProjectActions');
            const countEl = document.getElementById('drawCount');
            if (countEl) countEl.innerText = count;

            if (count > 0) { container.style.display = 'flex'; isManualMode = true; } else { container.style.display = 'none'; }
        }

        function finishNewProjectDrawing() {
            if (tempNewLayersGroup.getLayers().length === 0) return;
            map.pm.disableGlobalRemovalMode();
            tempNewLayersGroup.getLayers().forEach(l => l.pm.disable());
            
            // üî• FIX: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≤‡∏á‡∏•‡∏ö
            resetEraserTool();

            resetBudgetForm();
            document.getElementById('editProjectId').value = '';
            document.getElementById('modalTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('btnDelete').style.display = 'none';
            document.getElementById('btnStartEditGeom').style.display = 'none';
            new bootstrap.Modal(document.getElementById('projectFormModal')).show();

        }

        function cancelNewProjectDrawing() {
            Swal.fire({ title: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î?', icon: 'warning', showCancelButton: true, confirmButtonText: '‡πÉ‡∏ä‡πà' }).then((r) => {
                if (r.isConfirmed) { 
                    tempNewLayersGroup.clearLayers(); 
                    updateNewProjectButtons(); 
                    
                    // üî• FIX: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≤‡∏á‡∏•‡∏ö
                    resetEraserTool();
                    isManualMode = false; 
                    
                    map.pm.disableGlobalRemovalMode(); 
                }
            });
            document.getElementById("iconInputNew").value = "&#xF3E7;";
        }

        function cancelModal() {

            if (originalGeoJSONBackup) {
                // ... (Logic ‡∏•‡∏ö Layer ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                if (currentEditLayer && projectLayerGroup.hasLayer(currentEditLayer)) {
                    projectLayerGroup.removeLayer(currentEditLayer);
                }

                // ... (Logic ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô Layer ‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                const restoredLayer = L.geoJSON(originalGeoJSONBackup, {
                    style: (f) => ({ color: f.properties.color || '#ffc107', weight: f.geometry.type.includes('Line') ? 6 : 2, opacity: 0.9 }),
                    interactive: true,
                    pointToLayer: (f, latlng) => {
                        const iconCode = f.properties.icon || 'default';
                        const colorCode = f.properties.color || '#ffc107';
                        const marker = L.marker(latlng, { icon: getCustomIcon(iconCode, colorCode) });
                        marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleStackClick(e); });
                        return marker;
                    },
                    onEachFeature: (f, l) => { l.on('click', (e) => { handleStackClick(e); }); }
                }).getLayers()[0];
                
                currentEditLayer = restoredLayer;
                projectLayerGroup.addLayer(currentEditLayer);

                // üî• FIX: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Input (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/‡∏™‡∏µ) ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (Backup) ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                // (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ User ‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
                const oldProps = originalGeoJSONBackup.properties || {};
                document.getElementById('iconInputEdit').value = oldProps.icon || '&#xF3E7;';
                document.getElementById('colorInputEdit').value = oldProps.color || '#ffc107';
            }
            // 1. ‡∏ã‡πà‡∏≠‡∏ô Modal
            const modalEl = document.getElementById('projectFormModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) modalInstance.hide();

            const pid = document.getElementById('editProjectId').value;

            // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏´‡∏ô?
            if (pid) {
                // ============ üü° ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (EDIT MODE) ============
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î
                if (document.getElementById('editGeomControls').style.display === 'flex') {
                    cancelGeometryEdit();
                } 
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î (‡πÅ‡∏Å‡πâ‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Input ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å DB
                else if (currentEditLayer && currentEditLayer.feature && currentEditLayer.feature.properties) {
                    const props = currentEditLayer.feature.properties;
                    document.getElementById('iconInputEdit').value = props.icon || '&#xF3E7;';
                    document.getElementById('colorInputEdit').value = props.color || '#ffc107';
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                    if(typeof updateRealtimeStyle === 'function') updateRealtimeStyle('edit');
                }

            } else {
                // ============ üü¢ ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (ADD MODE) ============
                
                // üî• FIX: ‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î (Clear Layers) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ User ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                tempNewLayersGroup.clearLayers();
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 0
                updateNewProjectButtons();
                
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏™‡∏µ/‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Default
                if(typeof resetNewProjectInputs === 'function') resetNewProjectInputs();
                
                isManualMode = false;
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏≤‡∏á‡∏•‡∏ö
            if(typeof resetEraserTool === 'function') resetEraserTool();
        }

        async function openEditModal(f, l) {
            if (isManualMode) return;
            const pid = f.properties.fid || f.properties.id; if (!pid) return;
            currentEditLayer = l;
            document.getElementById('editProjectId').value = pid;
            document.getElementById('modalTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£';
            document.getElementById('btnDelete').style.display = 'block';
            document.getElementById('btnStartEditGeom').style.display = 'flex';

            document.getElementById('inpName').value = f.properties.project || f.properties.name || '';
            document.getElementById('inpMoo').value = f.properties.moo || 1;
            document.getElementById('inpDept').value = f.properties.authority || f.properties.dept || '';

            const box = document.getElementById('budgetList'); box.innerHTML = '';
            const { data } = await db.from('project_budgets').select('*').eq('project_id', pid).order('budget_year');
            if (data && data.length) data.forEach(b => addBudgetRow(b.budget_year, b.amount)); else addBudgetRow(2567, '');
            new bootstrap.Modal(document.getElementById('projectFormModal')).show();
        }

        async function saveProject() {
            const pid = document.getElementById('editProjectId').value;
            
            // 1. ‡∏£‡∏∞‡∏ö‡∏∏ Context ‡∏ß‡πà‡∏≤ Save ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏´‡∏ô (New ‡∏´‡∏£‡∏∑‡∏≠ Edit)
            const context = pid ? 'Edit' : 'New';
            
            // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Panel ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            const icon = document.getElementById('iconInput' + context).value;
            const color = document.getElementById('colorInput' + context).value;

            const name = document.getElementById('inpName').value; 
            const moo = document.getElementById('inpMoo').value; 
            const dept = document.getElementById('inpDept').value;
            
            let budgets = []; 
            document.querySelectorAll('.budget-row').forEach(row => { 
                const y = row.querySelector('.inp-year').value; 
                const a = row.querySelector('.inp-amount').value; 
                if (y) budgets.push({ budget_year: parseInt(y), amount: a ? parseFloat(a) : 0 }); 
            });

            if (!name) { Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠', 'warning'); return; }
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });

            try {
                let geometry;
                if (pid) {
                    const geojson = currentEditLayer.toGeoJSON();
                    if (geojson.features && geojson.features.length > 0) {
                        geometry = geojson.features[0].geometry;
                    } else {
                        geometry = geojson.geometry;
                    }
                } else {
                    const layers = tempNewLayersGroup.getLayers();
                    const geojsons = layers.map(l => l.toGeoJSON());
                    if (layers.length === 1) geometry = geojsons[0].geometry;
                    else {
                        const type = geojsons[0].geometry.type;
                        const coords = geojsons.map(g => g.geometry.coordinates);
                        if (type === 'LineString') geometry = { type: 'MultiLineString', coordinates: coords };
                        else if (type === 'Polygon') geometry = { type: 'MultiPolygon', coordinates: coords };
                        else geometry = { type: 'MultiPoint', coordinates: coords };
                    }
                }

                let savedId = pid;
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Payload ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á icon ‡πÅ‡∏•‡∏∞ color
                const payload = { 
                    project: name, 
                    moo: parseInt(moo), 
                    authority: dept, 
                    geom: geometry,
                    icon: icon,   // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
                    color: color  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏µ
                };

                if (!pid) {
                    const { data, error } = await db.from('sanklang_projects').insert([payload]).select().single();
                    if (error) throw error; savedId = data.fid;
                } else {
                    const { error } = await db.from('sanklang_projects').update(payload).eq('fid', pid);
                    if (error) throw error;
                    await db.from('project_budgets').delete().eq('project_id', pid);
                }

                if (budgets.length > 0) {
                    const budgetPayload = budgets.map(b => ({ ...b, project_id: savedId }));
                    await db.from('project_budgets').insert(budgetPayload);
                }

                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                bootstrap.Modal.getInstance(document.getElementById('projectFormModal')).hide();
                tempNewLayersGroup.clearLayers();
                updateNewProjectButtons();
                loadExistingProjects();
                isManualMode = false;
            } catch (e) { console.error(e); Swal.fire('Error', e.message, 'error'); }
        }

        function addBudgetRow(y = '', a = '') {
            const div = document.createElement('div'); div.className = 'row g-2 mb-2 budget-row';
            div.innerHTML = `<div class="col-5"><input type="number" class="form-control inp-year" value="${y}" placeholder="‡∏õ‡∏µ"></div><div class="col-5"><input type="number" class="form-control inp-amount" value="${a}" placeholder="‡∏ö‡∏≤‡∏ó"></div><div class="col-2"><button type="button" class="btn btn-outline-danger w-100" onclick="this.closest('.row').remove()"><i class="fa-solid fa-trash"></i></button></div>`;
            document.getElementById('budgetList').appendChild(div);
        }
        function resetBudgetForm() { document.getElementById('budgetList').innerHTML = ''; addBudgetRow(2567, ''); document.getElementById('newProjectForm').reset(); }
        async function deleteProject() { const pid = document.getElementById('editProjectId').value; if (await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?', icon: 'warning', showCancelButton: true }).then(r => r.isConfirmed)) { await db.from('sanklang_projects').delete().eq('fid', pid); bootstrap.Modal.getInstance(document.getElementById('projectFormModal')).hide(); loadExistingProjects(); isManualMode = false; } }

        async function loadExistingProjects() {
            projectLayerGroup.clearLayers(); const { data } = await db.rpc('get_map_data');
            if (data && data.features) {
                allFeatures = data.features; const yearsSet = new Set();
                allFeatures.forEach(f => { if (f.properties.budget_history) f.properties.budget_history.forEach(b => yearsSet.add(b.year)); });
                const sortedYears = Array.from(yearsSet).sort(); const yearSelect = document.getElementById('filterYear');
                yearSelect.innerHTML = '<option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì --</option>'; sortedYears.forEach(y => { const option = document.createElement('option'); option.value = y; option.textContent = `‡∏û.‡∏®. ${y}`; yearSelect.appendChild(option); });
                applyFilters();
            }
        }
        function applyFilters() {
            const kw = document.getElementById('sidebarSearch').value.toLowerCase().split(' ').filter(x => x);
            const yr = document.getElementById('filterYear').value; const mo = document.getElementById('filterMoo').value;
            const filtered = allFeatures.filter(f => {
                const p = f.properties; const name = (p.project || p.name || '').toLowerCase();
                return (kw.length === 0 || kw.every(k => name.includes(k))) && (mo === 'all' || p.moo == mo) && (yr === 'all' || (p.budget_history && p.budget_history.some(b => b.year == yr)));
            });
            filteredFeaturesGlobal = filtered; renderFilteredLayers(filtered); renderFilteredList(filtered); document.getElementById('resultCount').innerText = `‡∏û‡∏ö ${filtered.length} ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£`;
        }
        function renderFilteredLayers(features) {
            projectLayerGroup.clearLayers();
            const tempLayer = L.geoJSON(features, {
                interactive: true,
                
                // üî• FIX: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏•‡∏∞ Polygon ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏™‡∏∏‡πà‡∏° (Random) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏á‡πà‡∏≤‡∏¢
                style: f => ({ 
                    color: getRandomColor(), // <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏™‡∏µ
                    weight: f.geometry.type.includes('Line') ? 6 : 2, 
                    opacity: 0.9,
                    fillOpacity: 0.4 // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
                }),
                
                // üî• ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏∏‡∏î (Marker) ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏à‡∏≤‡∏Å Database ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                pointToLayer: (feature, latlng) => {
                    const iconCode = feature.properties.icon || 'default';
                    const colorCode = feature.properties.color || '#ffc107'; // ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏à‡∏≤‡∏Å DB
                    
                    const marker = L.marker(latlng, { icon: getCustomIcon(iconCode, colorCode) });
                    marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleStackClick(e); });
                    return marker;
                },
                
                onEachFeature: (f, l) => {
                    if (f.geometry.type !== 'Point') {
                        l.on('click', (e) => { L.DomEvent.stopPropagation(e); handleStackClick(e); });
                    }
                }
            });
            tempLayer.eachLayer(l => projectLayerGroup.addLayer(l));
        }
        function renderFilteredList(features) {
            const box = document.getElementById('sidebarList'); box.innerHTML = '';
            features.forEach((f, i) => {
                const div = document.createElement('div'); div.className = 'result-item';
                div.innerHTML = `<div class="fw-bold text-primary text-truncate">${f.properties.name || f.properties.project}</div><small class="text-muted">‡∏°.${f.properties.moo} | ${f.properties.authority || f.properties.dept}</small>`;
                div.onclick = () => {
                    const target = projectLayerGroup.getLayers().find(l => (l.feature.properties.fid || l.feature.properties.id) == (f.properties.fid || f.properties.id));
                    if (target) {
                        if (target.getBounds) map.flyTo(target.getBounds().getCenter(), 18); else map.flyTo(target.getLatLng(), 18);
                        openSidebar([f]);
                    }
                };
                box.appendChild(div);
            });
        }
        function toggleListSidebar() { document.getElementById('listSidebar').classList.toggle('active'); }
        function closeSidebar() { document.getElementById('selectionSidebar').classList.remove('active'); }

        // üî• FIX SHARE EYE BUG: Separate toggles completely
        function toggleLayer(type, element) {
            let target;
            if (type === 'project') target = projectLayerGroup;
            else if (type === 'moo') target = mooLayer;
            else if (type === 'boundary') target = boundaryLayer;
            else if (type === 'soi') target = soiLayer;

            if (target) {
                var icon = element.querySelector('i.fa-eye') || element.querySelector('i.fa-eye-slash');
                if (map.hasLayer(target)) {
                    map.removeLayer(target);
                    if (icon) { icon.className = 'fa-solid fa-eye-slash text-muted eye-icon'; }
                } else {
                    map.addLayer(target);
                    if (icon) { icon.className = 'fa-solid fa-eye text-primary eye-icon'; }
                }
            }
        }

        // üî• FIX SOI: Use New RPC Function + DEFAULT HIDDEN & CLEAN STYLE
        async function loadSoi() {
            try {
                const { data, error } = await db.rpc('get_sanklang_soi_final');
                if (data) {
                    soiLayer = L.geoJSON(data, {
                        interactive: false,
                        pane: 'soiPane',
                        // üî• Default Hidden: DO NOT .addTo(map)
                        style: { color: "#6c757d", weight: 2, opacity: 0.6 } // Solid line (no dash), clean gray
                    });
                    // Removed map.fitBounds(soiLayer.getBounds());
                    console.log("Soi Layer Loaded:", data.length);
                }
            } catch (e) { console.error("Soi load error:", e); }
        }

        async function loadMoo() { try { const { data } = await db.rpc('get_moo_boundary'); if (data) mooLayer = L.geoJSON(data, { interactive: false, style: { color: "#1976d2", fillOpacity: 0.1, dashArray: '5,5' }, onEachFeature: (f, l) => l.bindTooltip(`‡∏´‡∏°‡∏π‡πà ${f.properties.moo_no}`, { permanent: true, direction: "center" }) }).addTo(map); } catch (e) { } }
        async function loadBoundary() { try { const { data } = await db.rpc('get_tambon_boundary'); if (data) boundaryLayer = L.geoJSON(data, { interactive: false, style: { color: "#d32f2f", fill: false, dashArray: '10,5' } }).addTo(map); } catch (e) { } }


        function resetNewProjectInputs() {
            // 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Default
            document.getElementById("iconInputNew").value = "&#xF3E7;";
            document.getElementById("colorInputNew").value = "#ffc107";
            
            // 2. üî• ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            updateRealtimeStyle('new');
        }




        document.addEventListener('DOMContentLoaded', checkSession);
        document.getElementById("iconInputNew").value = "&#xF3E7;";
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('authPassword');
            const eyeIcon = document.getElementById('eyeIcon');
            
            // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏≤‡∏™‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô text (‡πÅ‡∏™‡∏î‡∏á)
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡πÇ‡∏î‡∏ô‡∏Ç‡∏µ‡∏î‡∏ó‡∏±‡∏ö
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
            }
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Private Client)</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            overflow: hidden;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- ‡∏£‡∏∞‡∏ö‡∏ö Login --- */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #212529;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* --- ‡∏£‡∏∞‡∏ö‡∏ö Loading --- */
        #dataLoadingOverlay {
            position: fixed;
            top: 60px;
            left: 0;
            width: 100%;
            height: calc(100vh - 60px);
            background: rgba(255, 255, 255, 0.8);
            z-index: 9998;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #0d6efd;
            margin-bottom: 15px;
        }

        .loading-text {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        /* --- Navbar & Map --- */
        .top-navbar {
            height: 60px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1020;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .nav-brand {
            font-weight: 700;
            color: #0d6efd;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-tools {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            border: 1px solid #eee;
            background: white;
            padding: 6px 15px;
            border-radius: 20px;
            color: #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .nav-btn:hover { background: #f8f9fa; }
        .nav-btn.active { background: #e7f1ff; color: #0d6efd; border-color: #0d6efd; font-weight: bold; }
        
        .nav-btn-danger { color: #dc3545; border-color: #ffeaea; }
        .nav-btn-danger:hover { background: #dc3545; color: white; }

        .custom-marker-icon {
            display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; color: white; font-size: 16px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid white;
            font-family: 'bootstrap-icons' !important; 
            font-style: normal;
        }

        #map { flex-grow: 1; width: 100%; z-index: 1; }

        /* --- Panels & Sidebars --- */
        .draggable-panel {
            position: absolute;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1030;
            display: none;
            border: 1px solid #eee;
        }

        .panel-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            border-radius: 10px 10px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-body { padding: 15px; max-height: 70vh; overflow-y: auto; }

        .list-sidebar, .selection-sidebar {
            position: fixed;
            top: 60px;
            width: 350px;
            height: calc(100vh - 60px);
            background: white;
            z-index: 1025;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.15);
            transition: all 0.4s;
            display: flex;
            flex-direction: column;
        }

        .list-sidebar { left: -400px; }
        .list-sidebar.active { left: 0; }
        
        .selection-sidebar { right: -400px; box-shadow: -5px 0 25px rgba(0, 0, 0, 0.15); }
        .selection-sidebar.active { right: 0; }

        .layer-item {
            display: flex; justify-content: space-between; padding: 8px 0;
            border-bottom: 1px solid #f0f0f0; cursor: pointer;
        }

        .result-item { cursor: pointer; padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .result-item:hover { background: #f8f9fa; border-left: 4px solid #0d6efd; }
    </style>
</head>

<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h3 class="fw-bold mb-1 text-dark">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <p class="text-muted small mb-3">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</p>
            
            <div id="loginError" class="alert alert-danger d-none p-2 mb-3 mt-3 text-start small" role="alert">
                <i class="fa-solid fa-circle-exclamation"></i> <span id="errorText">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <input type="email" id="authEmail" class="form-control mb-3 mt-3" placeholder="client@example.com" required>
                
                <div class="input-group mb-4">
                    <input type="password" id="authPassword" class="form-control" placeholder="password" required>
                    <button class="btn btn-outline-secondary" style="min-width: 46px;" type="button" id="btnTogglePassword" onclick="togglePasswordVisibility()">
                        <i class="fa-solid fa-eye" id="eyeIcon"></i>
                    </button>
                </div>

                <button type="submit" id="loginBtn" class="btn btn-primary w-100 fw-bold py-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
        </div>
    </div>

    <nav class="top-navbar">
        <div class="nav-brand"><i class="fa-solid fa-map-location-dot"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
        <div class="nav-tools">
            <button class="nav-btn" id="btn-filter" onclick="togglePanel('filterPanel', 'btn-filter')"><i class="fa-solid fa-filter"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
            <button class="nav-btn" id="btn-layer" onclick="togglePanel('layerPanel', 'btn-layer')"><i class="fa-solid fa-layer-group"></i> ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå</button>
            <div class="vr mx-2"></div>
            <button class="nav-btn active" id="btn-street" onclick="setMapType('street')">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
            <button class="nav-btn" id="btn-satellite" onclick="setMapType('satellite')">‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</button>
            <div class="vr mx-2"></div>
            <button class="nav-btn nav-btn-danger" onclick="handleLogout()"><i class="fa-solid fa-power-off"></i> ‡∏≠‡∏≠‡∏Å</button>
        </div>
    </nav>

    <div id="map"></div>

    <div id="dataLoadingOverlay">
        <div class="spinner-border" role="status"></div>
        <div class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>
    </div>

    <div id="filterPanel" class="draggable-panel" style="top: 80px; left: 20px;">
        <div class="panel-header">
            <h6 class="panel-title mb-0"><i class="fa-solid fa-magnifying-glass"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á</h6>
            <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="togglePanel('filterPanel', 'btn-filter')"></i>
        </div>
        <div class="panel-body">
            <div class="mb-2">
                <select id="filterYear" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì --</option>
                </select>
            </div>
            <div class="mb-3">
                <select id="filterMoo" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô --</option>
                    <option value="1">‡∏´‡∏°‡∏π‡πà 1</option>
                    <option value="2">‡∏´‡∏°‡∏π‡πà 2</option>
                    <option value="3">‡∏´‡∏°‡∏π‡πà 3</option>
                    <option value="4">‡∏´‡∏°‡∏π‡πà 4</option>
                    <option value="5">‡∏´‡∏°‡∏π‡πà 5</option>
                </select>
            </div>
            <button onclick="toggleListSidebar()" class="btn btn-primary w-100 rounded-pill fw-bold btn-sm">
                <i class="fa-solid fa-list-ul"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ / ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
        </div>
    </div>

    <div id="layerPanel" class="draggable-panel" style="top: 80px; left: 340px;">
        <div class="panel-header">
            <h6 class="panel-title mb-0"><i class="fa-solid fa-layers"></i> ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå</h6>
            <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="togglePanel('layerPanel', 'btn-layer')"></i>
        </div>
        <div class="panel-body">
            <div class="layer-item" onclick="toggleLayer('project', this)"><span class="small fw-bold"><i class="fa-solid fa-circle text-warning me-2"></i> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span><i class="fa-solid fa-eye text-primary"></i></div>
            <div class="layer-item" onclick="toggleLayer('soi', this)"><span class="small fw-bold"><i class="fa-solid fa-road text-secondary me-2"></i> ‡∏ã‡∏≠‡∏¢ (Soi)</span><i class="fa-solid fa-eye-slash text-muted eye-icon"></i></div>
            <div class="layer-item" onclick="toggleLayer('moo', this)"><span class="small fw-bold"><i class="fa-regular fa-square text-primary me-2"></i> ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏´‡∏°‡∏π‡πà</span><i class="fa-solid fa-eye text-primary"></i></div>
            <div class="layer-item" onclick="toggleLayer('boundary', this)"><span class="small fw-bold"><i class="fa-regular fa-square text-danger me-2"></i> ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≥‡∏ö‡∏•</span><i class="fa-solid fa-eye text-primary"></i></div>
        </div>
    </div>

    <div id="listSidebar" class="list-sidebar">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
            <h5 class="mb-0 fw-bold"><i class="fa-solid fa-list me-2"></i>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h5>
            <button class="btn btn-mb btn-outline-secondary rounded-circle" onclick="toggleListSidebar()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-3 bg-light border-bottom">
            <input type="text" id="sidebarSearch" class="form-control rounded-pill" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£..." onkeyup="applyFilters()">
            <div class="text-end mt-1"><small class="text-muted" id="resultCount">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small></div>
        </div>
        <div id="sidebarList" class="list-group list-group-flush" style="overflow-y:auto; flex-grow:1;"></div>
    </div>

    <div id="selectionSidebar" class="selection-sidebar">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
            <h5 class="mb-0 fw-bold text-primary"><i class="fa-solid fa-circle-info me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
            <button class="btn btn-mb btn-outline-secondary rounded-circle" onclick="closeSidebar()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="sidebarContent" class="p-3" style="overflow-y:auto; flex-grow:1;"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const supabaseUrl = 'https://azxinrvdwsvmchovvjpl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6eGlucnZkd3N2bWNob3Z2anBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MTY4NzMsImV4cCI6MjA4NjE5Mjg3M30.52JBZ4CFEKyVZMmTgNFgEUek75EyAbP0D7kxELh2EZk';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        var map = L.map('map', { center: [18.784, 99.075], zoom: 14, zoomControl: false, maxZoom: 22 });
        var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            attribution: '¬© OpenStreetMap', maxNativeZoom: 19, maxZoom: 22 
        }).addTo(map);        
        
        var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
            attribution: 'Tiles ¬© Esri', maxNativeZoom: 19, maxZoom: 22 
        });        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        map.createPane('soiPane');
        map.getPane('soiPane').style.zIndex = 450;

        let projectLayerGroup = L.featureGroup().addTo(map);
        let mooLayer, boundaryLayer, soiLayer;
        let allFeatures = [];
        let filteredFeaturesGlobal = [];
        let currentStack = [];

        // ==========================================
        // üî• ‡∏£‡∏∞‡∏ö‡∏ö Login & Role Check
        // ==========================================
        async function checkSession() { 
            const { data: { session } } = await db.auth.getSession(); 
            if (session) { 
                checkUserRoleAndInit(session.user.id); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ Role
            } else {
                document.getElementById('loginOverlay').style.opacity = '1';
                document.getElementById('loginOverlay').style.visibility = 'visible';
            }
        }

        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ Role ‡∏Ç‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á Client (‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô)
        async function checkUserRoleAndInit(userId) {
            const { data: roleData, error } = await db
                .from('user_roles')
                .select('role')
                .eq('user_id', userId)
                .single();

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏î‡∏∂‡∏á Role ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠ Role ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ó‡∏±‡πâ‡∏á admin ‡πÅ‡∏•‡∏∞ client
            if (error || !roleData || (roleData.role !== 'client')) {
                alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ");
                await db.auth.signOut(); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å
                window.location.reload(); // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏Ñ‡∏•‡∏µ‡∏ô‡πÜ
                return;
            }

            // ‡∏ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠ client) ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤ Overlay ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            document.getElementById('loginOverlay').style.opacity = '0'; 
            setTimeout(async () => { 
                document.getElementById('loginOverlay').style.visibility = 'hidden'; 
                initApp(); // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ Client
            }, 500); 
        }

        async function handleLogin(e) { 
            e.preventDefault(); 
            const btn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');

            errorDiv.classList.add('d-none');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<span> verifying . . .  </span>';
            btn.disabled = true;

            const { data, error } = await db.auth.signInWithPassword({ 
                email: document.getElementById('authEmail').value, 
                password: document.getElementById('authPassword').value 
            }); 
            
            if (error) { 
                if (error.message.includes('Invalid login credentials')) {
                    errorText.innerText = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                } else {
                    errorText.innerText = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                }
                errorDiv.classList.remove('d-none');
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            } else { 
                checkUserRoleAndInit(data.user.id); 
            } 
        }

        async function checkUserRoleAndRedirect(userId) {
            // ‡∏î‡∏∂‡∏á Role ‡∏à‡∏≤‡∏Å Supabase
            const { data: roleData, error } = await db
                .from('user_roles')
                .select('role')
                .eq('user_id', userId)
                .single();

            // 1. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ Role ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î Error
            if (error || !roleData) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö");
                await db.auth.signOut();
                window.location.reload();
                return;
            }

            // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin
            if (roleData.role === 'admin') {
                window.location.href = 'admin.html'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            } 
            // 3. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Client ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠ (‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
            else if (roleData.role === 'client') {
                document.getElementById('loginOverlay').style.opacity = '0'; 
                setTimeout(async () => { 
                    document.getElementById('loginOverlay').style.visibility = 'hidden'; 
                    initApp(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                }, 500); 
            }
        }

        async function handleLogout() { 
            await db.auth.signOut(); 
            window.location.reload(); 
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('authPassword');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        // ==========================================
        // UI & Panel Actions
        // ==========================================
        function togglePanel(id, btnId) { 
            const p = document.getElementById(id); 
            const b = document.getElementById(btnId); 
            p.style.display = (p.style.display === 'none' || p.style.display === '') ? 'block' : 'none'; 
            if (b) b.classList.toggle('active'); 
        }

        function preventMapClick(id) { 
            const el = document.getElementById(id); 
            if (el) { L.DomEvent.disableClickPropagation(el); L.DomEvent.disableScrollPropagation(el); } 
        }
        preventMapClick('filterPanel'); preventMapClick('layerPanel'); preventMapClick('listSidebar'); preventMapClick('selectionSidebar');

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; 
            element.querySelector('.panel-header').onmousedown = e => { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDrag; document.onmousemove = elmDrag; };
            function elmDrag(e) { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; element.style.top = (element.offsetTop - pos2) + "px"; element.style.left = (element.offsetLeft - pos1) + "px"; }
            function closeDrag() { document.onmouseup = null; document.onmousemove = null; }
        }
        makeDraggable(document.getElementById("filterPanel")); makeDraggable(document.getElementById("layerPanel"));

        function setMapType(type) { 
            if (type === 'street') { map.addLayer(streetMap); map.removeLayer(satelliteMap); } 
            else { map.addLayer(satelliteMap); map.removeLayer(streetMap); } 
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById('btn-' + type).classList.add('active'); 
        }

        function getCustomIcon(code, color) {
            if (!code || code === 'default') code = '&#xF3E7;';
            if (!color) color = '#ffc107'; 
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="custom-marker-icon" style="width:30px;height:30px; background:${color};">${code}</div>`,
                iconSize: [30, 30], iconAnchor: [15, 15]
            });
        }

        // ==========================================
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á Login ‡∏ú‡πà‡∏≤‡∏ô)
        // ==========================================
        async function initApp() {
            document.getElementById('dataLoadingOverlay').style.display = 'flex';
            try {
                await Promise.all([
                    loadExistingProjects(),
                    loadMoo(),
                    loadBoundary(),
                    loadSoi()
                ]);
            } catch (error) {
                console.error("Error loading map data:", error);
            } finally {
                document.getElementById('dataLoadingOverlay').style.display = 'none';
            }
        }

        async function loadExistingProjects() {
            projectLayerGroup.clearLayers(); 
            const { data } = await db.rpc('get_map_data');
            if (data && data.features) {
                allFeatures = data.features; 
                const yearsSet = new Set();
                allFeatures.forEach(f => { if (f.properties.budget_history) f.properties.budget_history.forEach(b => yearsSet.add(b.year)); });
                const sortedYears = Array.from(yearsSet).sort(); 
                const yearSelect = document.getElementById('filterYear');
                yearSelect.innerHTML = '<option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì --</option>'; 
                sortedYears.forEach(y => { const option = document.createElement('option'); option.value = y; option.textContent = `‡∏û.‡∏®. ${y}`; yearSelect.appendChild(option); });
                applyFilters();
            }
        }

        async function loadMoo() { try { const { data } = await db.rpc('get_moo_boundary'); if (data) mooLayer = L.geoJSON(data, { interactive: false, style: { color: "#1976d2", fillOpacity: 0.1, dashArray: '5,5' }, onEachFeature: (f, l) => l.bindTooltip(`‡∏´‡∏°‡∏π‡πà ${f.properties.moo_no}`, { permanent: true, direction: "center" }) }).addTo(map); } catch (e) { } }
        async function loadBoundary() { try { const { data } = await db.rpc('get_tambon_boundary'); if (data) boundaryLayer = L.geoJSON(data, { interactive: false, style: { color: "#d32f2f", fill: false, dashArray: '10,5' } }).addTo(map); } catch (e) { } }
        async function loadSoi() { 
            try { 
                const { data } = await db.rpc('get_sanklang_soi_final'); 
                if (data) { 
                    soiLayer = L.geoJSON(data, { interactive: false, pane: 'soiPane', style: { color: "#6c757d", weight: 2, opacity: 0.6 } }); 
                } 
            } catch (e) { } 
        }

        // ==========================================
        // STACK SEARCH LOGIC
        // ==========================================
        function isPointInPolygon(point, vs) {
            var x = point[0], y = point[1]; var inside = false;
            for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                var xi = vs[i][0], yi = vs[i][1]; var xj = vs[j][0], yj = vs[j][1];
                var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            } return inside;
        }

        function isPointInMultiPolygon(point, multiPolyCoords) {
            for (let i = 0; i < multiPolyCoords.length; i++) {
                let ring = multiPolyCoords[i][0]; if (isPointInPolygon(point, ring)) return true;
            } return false;
        }

        function handleStackClick(e) {
            const clickLat = e.latlng.lat;
            const clickLng = e.latlng.lng;
            const clickPoint = [clickLng, clickLat]; 

            const foundProjects = [];

            filteredFeaturesGlobal.forEach(feature => {
                const geom = feature.geometry;
                if (geom.type === 'Polygon') {
                    if (isPointInPolygon(clickPoint, geom.coordinates[0])) foundProjects.push(feature);
                } else if (geom.type === 'MultiPolygon') {
                    if (isPointInMultiPolygon(clickPoint, geom.coordinates)) foundProjects.push(feature);
                } else if (geom.type === 'Point') {
                    const dist = map.distance(e.latlng, L.latLng(geom.coordinates[1], geom.coordinates[0]));
                    if (dist < 20) foundProjects.push(feature);
                } else if (geom.type === 'MultiPoint') {
                    for (let coord of geom.coordinates) {
                        const dist = map.distance(e.latlng, L.latLng(coord[1], coord[0]));
                        if (dist < 20) { foundProjects.push(feature); break; }
                    }
                } else if (geom.type.includes('Line')) {
                    const pt = turf.point([clickLng, clickLat]);
                    let isNear = false;
                    try {
                        if (geom.type === 'MultiLineString') {
                            for (let coords of geom.coordinates) {
                                const d = turf.pointToLineDistance(pt, turf.lineString(coords), { units: 'meters' });
                                if (d < 15) { isNear = true; break; }
                            }
                        } else {
                            const d = turf.pointToLineDistance(pt, turf.lineString(geom.coordinates), { units: 'meters' });
                            if (d < 15) isNear = true;
                        }
                    } catch (err) { }
                    if (isNear) foundProjects.push(feature);
                }
            });

            if (foundProjects.length > 0) {
                L.DomEvent.stopPropagation(e);
                openSidebar(foundProjects);
            }
        }

        map.on('click', handleStackClick);

        function openSidebar(features) {
            currentStack = features;
            if (features.length > 1) { showStackList(features); }
            else if (features.length === 1) { renderDetail(features[0].properties); }
        }

        function showStackList(features) {
            const content = document.getElementById('sidebarContent');
            let listHtml = `<h5 class="fw-bold mb-3 text-dark"><i class="fa-solid fa-layer-group text-primary"></i> ‡∏û‡∏ö ${features.length} ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h5><div class="list-group">`;
            features.forEach((f, index) => {
                const p = f.properties;
                listHtml += `<button onclick="openDetailFromStack(${index})" class="list-group-item list-group-item-action p-3 mb-2 border rounded shadow-sm text-start"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 fw-bold text-primary text-truncate" style="max-width: 200px;">${p.name || p.project}</h6></div><small class="text-muted"><i class="fa-solid fa-building"></i> ${p.dept || p.authority}</small></button>`;
            });
            listHtml += `</div>`;
            content.innerHTML = listHtml;
            document.getElementById('selectionSidebar').classList.add('active');
        }

        function openDetailFromStack(index) { renderDetail(currentStack[index].properties); }

        function renderDetail(props) {
            const content = document.getElementById('sidebarContent');
            let budgetHtml = '';
            if (props.budget_history && props.budget_history.length > 0) {
                props.budget_history.forEach(b => { const money = new Intl.NumberFormat('th-TH').format(b.amount); budgetHtml += `<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-white"><span class="badge bg-primary">‡∏õ‡∏µ ${b.year}</span><span class="fw-bold text-dark">${money} ‡∏ö‡∏≤‡∏ó</span></div>`; });
            } else { budgetHtml = `<div class="text-center text-muted p-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>`; }

            let backBtn = '';
            if (currentStack.length > 1) { backBtn = `<button onclick="showStackList(currentStack)" class="btn btn-sm btn-outline-secondary mb-3"><i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>`; }

            content.innerHTML = `
                ${backBtn}
                <h4 class="fw-bold text-primary mb-3" style="line-height:1.4;">${props.name || props.project}</h4>
                <div class="bg-white p-3 rounded shadow-sm border mb-3">
                    <div class="mb-2"><strong><i class="fa-solid fa-map-pin text-danger me-2"></i>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong> ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà ${props.moo}</div>
                    <div class="mb-0"><strong><i class="fa-solid fa-building text-info me-2"></i>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${props.dept || props.authority}</div>
                </div>
                
                <h6 class="fw-bold mt-2 mb-2 text-secondary">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h6>
                <div class="bg-light p-2 rounded border mb-4">${budgetHtml}</div>
            `;
            document.getElementById('selectionSidebar').classList.add('active');
        }

        function applyFilters() {
            const kw = document.getElementById('sidebarSearch').value.toLowerCase().split(' ').filter(x => x);
            const yr = document.getElementById('filterYear').value; const mo = document.getElementById('filterMoo').value;
            const filtered = allFeatures.filter(f => {
                const p = f.properties; const name = (p.project || p.name || '').toLowerCase();
                return (kw.length === 0 || kw.every(k => name.includes(k))) && (mo === 'all' || p.moo == mo) && (yr === 'all' || (p.budget_history && p.budget_history.some(b => b.year == yr)));
            });
            filteredFeaturesGlobal = filtered; renderFilteredLayers(filtered); renderFilteredList(filtered); document.getElementById('resultCount').innerText = `‡∏û‡∏ö ${filtered.length} ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£`;
        }

        function renderFilteredLayers(features) {
            projectLayerGroup.clearLayers();
            const tempLayer = L.geoJSON(features, {
                interactive: true,
                // üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏™‡∏µ‡∏à‡∏≤‡∏Å Database (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
                style: f => ({ 
                    color: f.properties.color || '#0d6efd', 
                    weight: f.geometry.type.includes('Line') ? 5 : 2, 
                    opacity: 0.9,
                    fillOpacity: 0.3 
                }),
                pointToLayer: (feature, latlng) => {
                    const iconCode = feature.properties.icon || 'default';
                    const colorCode = feature.properties.color || '#ffc107'; 
                    const marker = L.marker(latlng, { icon: getCustomIcon(iconCode, colorCode) });
                    marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleStackClick(e); });
                    return marker;
                },
                onEachFeature: (f, l) => {
                    if (f.geometry.type !== 'Point') {
                        l.on('click', (e) => { L.DomEvent.stopPropagation(e); handleStackClick(e); });
                    }
                }
            });
            tempLayer.eachLayer(l => projectLayerGroup.addLayer(l));
        }

        function renderFilteredList(features) {
            const box = document.getElementById('sidebarList'); box.innerHTML = '';
            features.forEach((f) => {
                const div = document.createElement('div'); div.className = 'result-item';
                div.innerHTML = `<div class="fw-bold text-primary text-truncate">${f.properties.name || f.properties.project}</div><small class="text-muted">‡∏°.${f.properties.moo} | ${f.properties.authority || f.properties.dept}</small>`;
                div.onclick = () => {
                    const target = projectLayerGroup.getLayers().find(l => (l.feature.properties.fid || l.feature.properties.id) == (f.properties.fid || f.properties.id));
                    if (target) {
                        if (target.getBounds) map.flyTo(target.getBounds().getCenter(), 18); else map.flyTo(target.getLatLng(), 18);
                        openSidebar([f]);
                    }
                };
                box.appendChild(div);
            });
        }

        function toggleListSidebar() { document.getElementById('listSidebar').classList.toggle('active'); }
        function closeSidebar() { document.getElementById('selectionSidebar').classList.remove('active'); }

        function toggleLayer(type, element) {
            let target;
            if (type === 'project') target = projectLayerGroup;
            else if (type === 'moo') target = mooLayer;
            else if (type === 'boundary') target = boundaryLayer;
            else if (type === 'soi') target = soiLayer;

            if (target) {
                var icon = element.querySelector('i.fa-eye') || element.querySelector('i.fa-eye-slash');
                if (map.hasLayer(target)) {
                    map.removeLayer(target);
                    if (icon) { icon.className = 'fa-solid fa-eye-slash text-muted eye-icon'; }
                } else {
                    map.addLayer(target);
                    if (icon) { icon.className = 'fa-solid fa-eye text-primary eye-icon'; }
                }
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Session ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        document.addEventListener('DOMContentLoaded', checkSession);

    </script>
</body>

</html>